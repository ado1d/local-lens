<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feed - LocalLens</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<%- include('partials/header') %>

<div class="container my-4">
  <h1 class="mb-3 text-center fw-bold">Community Feed</h1>
  <p class="text-center mb-5 lead">Stay connected with your neighbourhood – share updates, events and recommendations.</p>

  <div class="row">
    <!-- Sidebar filter panel -->
    <div class="col-lg-3 mb-4">
      <div class="filter-panel p-3">
        <h5 class="fw-bold mb-3">Category</h5>
        <% const allCount = (counts.issue || 0) + (counts.event || 0) + (counts.recommendation || 0) + (counts.general || 0); %>
        <%
          // Build query string segments for sort and search so category links preserve them.
          const sortParam = selectedSort ? `&sort=${selectedSort}` : '';
          const searchParam = searchTerm ? `&search=${searchTerm}` : '';
        %>
        <ul class="list-group">
          <li class="list-group-item d-flex justify-content-between align-items-center <%= !selectedCategory ? 'active' : '' %>">
            <% /* Build base query for all posts without category, but preserve sort and search. */ %>
            <% let allUrl = '/'; %>
            <% if (selectedSort || searchTerm) { %>
              <% allUrl += '?'; %>
              <% if (selectedSort) { allUrl += 'sort=' + selectedSort; } %>
              <% if (searchTerm) { allUrl += (selectedSort ? '&' : '') + 'search=' + searchTerm; } %>
            <% } %>
            <a href="<%= allUrl %>" class="flex-grow-1 text-reset text-decoration-none">
              All Posts
            </a>
            <span class="badge rounded-pill bg-light text-muted"><%= allCount %></span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center <%= selectedCategory === 'issue' ? 'active' : '' %>">
            <a href="/?category=issue<%= sortParam %><%= searchParam %>" class="flex-grow-1 text-reset text-decoration-none">
              Issues
            </a>
            <span class="badge rounded-pill bg-light text-muted"><%= counts.issue %></span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center <%= selectedCategory === 'event' ? 'active' : '' %>">
            <a href="/?category=event<%= sortParam %><%= searchParam %>" class="flex-grow-1 text-reset text-decoration-none">
              Events
            </a>
            <span class="badge rounded-pill bg-light text-muted"><%= counts.event %></span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center <%= selectedCategory === 'recommendation' ? 'active' : '' %>">
            <a href="/?category=recommendation<%= sortParam %><%= searchParam %>" class="flex-grow-1 text-reset text-decoration-none">
              Recommendations
            </a>
            <span class="badge rounded-pill bg-light text-muted"><%= counts.recommendation %></span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center <%= selectedCategory === 'general' ? 'active' : '' %>">
            <a href="/?category=general<%= sortParam %><%= searchParam %>" class="flex-grow-1 text-reset text-decoration-none">
              General Discussion
            </a>
            <span class="badge rounded-pill bg-light text-muted"><%= counts.general %></span>
          </li>
        </ul>

        <!-- Sort dropdown: maintain category and search term via hidden inputs -->
        <div class="mt-4">
          <label for="sort-select" class="form-label fw-bold">Sort By</label>
          <form id="sort-form" method="get">
            <% /* Preserve current category and search term when changing sort */ %>
            <% if (selectedCategory) { %>
              <input type="hidden" name="category" value="<%= selectedCategory %>">
            <% } %>
            <% if (searchTerm) { %>
              <input type="hidden" name="search" value="<%= searchTerm %>">
            <% } %>
            <select class="form-select form-select-sm" id="sort-select" name="sort" onchange="this.form.submit()">
              <option value="top" <%= selectedSort === 'top' ? 'selected' : '' %>>Top (Upvotes)</option>
              <option value="newest" <%= selectedSort === 'newest' ? 'selected' : '' %>>Newest</option>
              <option value="last_active" <%= selectedSort === 'last_active' ? 'selected' : '' %>>Last Active</option>
            </select>
          </form>
        </div>
      </div>
    </div>

    <!-- Posts list -->
    <div class="col-lg-9">
      <% if (posts.length === 0) { %>
        <div class="alert alert-warning text-center">No posts found for your area.</div>
      <% } else { %>
        <% posts.forEach(post => { %>
          <div class="post-card">
            <div class="votes">
              <span><%= post.upvotes %></span>
              <small class="text-muted">Upvotes</small>
            </div>
            <div class="content">
              <% /* Determine an icon based on the post category. These icons help
                 differentiate categories visually and provide an instant cue. */ %>
              <% let catIcon;
                 switch (post.category) {
                   case 'issue':
                     catIcon = 'bi-exclamation-triangle-fill';
                     break;
                   case 'event':
                     catIcon = 'bi-calendar-event';
                     break;
                   case 'recommendation':
                     catIcon = 'bi-lightbulb-fill';
                     break;
                   case 'general':
                   default:
                     catIcon = 'bi-chat-dots-fill';
                     break;
                 }
              %>
              <span class="category-badge <%= post.category %> d-inline-flex align-items-center">
                <i class="bi <%= catIcon %> me-1"></i>
                <%= post.category %>
              </span>
              <h3 class="title"><%= post.title %></h3>
              <small class="meta">Posted by <%= post.email %> • <%= new Date(post.created_at).toLocaleString() %></small>
              <p class="excerpt mt-2">
                <% if (post.content.length > 300) { %>
                  <%= post.content.substring(0, 300) %>...
                <% } else { %>
                  <%= post.content %>
                <% } %>
              </p>
              <div class="actions mt-3">
                <div class="vote-buttons d-flex align-items-center">
                  <form action="/posts/<%= post.id %>/upvote" method="POST" class="d-inline me-2">
                    <!-- Use Bootstrap icons for nicer vote buttons -->
                    <button type="submit" class="btn btn-link p-0" title="Upvote">
                      <i class="bi bi-hand-thumbs-up"></i>
                    </button>
                  </form>
                  <form action="/posts/<%= post.id %>/downvote" method="POST" class="d-inline me-3">
                    <button type="submit" class="btn btn-link p-0" title="Downvote">
                      <i class="bi bi-hand-thumbs-down"></i>
                    </button>
                  </form>
                </div>
                <a href="/posts/<%= post.id %>" class="btn btn-sm btn-outline-primary">View Details</a>
              </div>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
</body>
</html>

